// prisma/schema.prisma

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Contact {
  id               String          @id @default(uuid())
  name             String
  marketingConsent Boolean         @default(false)
  source           String?         // web_form, sms_opt_in, manual, etc.
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  // Lead Nurturing fields
  leadStatus       String          @default("NEW") // NEW, CONTACTED, INTERESTED, PROPOSAL_SENT, WON, LOST
  leadScore        Int             @default(0)
  nurturingStatus  String?         // ACTIVE, PAUSED, COMPLETED, NONE
  nurturingStep    Int             @default(0)
  lastContactedAt  DateTime?
  nextFollowUpAt   DateTime?
  interestedIn     String?         // web, ecommerce, app, marketing
  notes            String?         @db.Text

  // Relaciones
  emails           ContactEmail[]
  phones           ContactPhone[]
  activities       ContactActivity[]

  @@index([leadStatus])
  @@index([nurturingStatus])
}

// Lead Nurturing Activity Log
model ContactActivity {
  id          String   @id @default(uuid())
  contactId   String
  contact     Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)

  type        String   // EMAIL_SENT, EMAIL_OPENED, SEQUENCE_STARTED, SEQUENCE_COMPLETED, STATUS_CHANGED, NOTE_ADDED
  description String
  metadata    Json?    // Additional data (email subject, step number, etc.)

  createdAt   DateTime @default(now())

  @@index([contactId])
  @@index([type])
  @@index([createdAt])
}

model ContactEmail {
  id        String   @id @default(uuid())
  contactId String
  email     String   @unique
  contact   Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@index([email])
}

model ContactPhone {
  id        String   @id @default(uuid())
  contactId String
  phone     String   @unique
  type      String?  // mobile, home, work, etc.
  contact   Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@index([phone])
}

model User {
  id        String    @id @default(uuid())
  email     String    @unique
  password  String
  name      String
  isActive  Boolean   @default(true)
  lastLogin DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([email])
}

model Admin {
  id        String    @id @default(uuid())
  email     String    @unique
  password  String
  name      String
  isActive  Boolean   @default(true)
  lastLogin DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  
  @@index([email])
}


model EmailCampaign {
  id              String              @id @default(uuid())
  name            String
  subject         String
  htmlContent     String              @db.Text
  createdAt       DateTime            @default(now())
  sentAt          DateTime?
  completedAt     DateTime?
  emailsSent      Int                 @default(0)     // Total de emails enviados hasta ahora
  totalEmails     Int                 @default(0)     // Total de emails a enviar
  status          String              @default("pending")  // pending, in_progress, completed, failed, sending
  lastBatchSentAt DateTime?                           // Última vez que se envió un lote
  emailLogs       CampaignEmailLog[]

  @@index([status])
}

model CampaignEmailLog {
  id           String        @id @default(uuid())
  campaignId   String
  campaign     EmailCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  emailAddress String
  contactName  String
  sentAt       DateTime      @default(now())
  resendId     String?
  status       String        @default("sent") // sent, failed, bounced
  errorMessage String?

  @@index([campaignId])
  @@index([emailAddress])
  @@index([status])
}

model DailyEmailQuota {
  id          String   @id @default(uuid())
  date        DateTime @unique @db.Date
  emailsSent  Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([date])
}

model SmsCampaign {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())
  sentAt    DateTime?
  smsSent   Int      @default(0)  // Total de SMS enviados en esta campaña
}

model Payment {
  id              String    @id @default(uuid())
  projectCode     String    @unique @default(cuid()) // Código corto para el cliente
  accessToken     String    @unique @default(uuid()) // Token seguro para URLs
  email           String
  name            String
  planName        String
  totalAmount     Int       // Total en centavos
  firstPayment    Int       // Primer pago en centavos
  secondPayment   Int       // Segundo pago en centavos
  firstPaid       Boolean   @default(false)
  secondPaid      Boolean   @default(false)
  firstSessionId  String?   // Stripe session ID del primer pago
  secondSessionId String?   // Stripe session ID del segundo pago

  // Datos del proyecto
  projectStatus   String    @default("pending") // pending, in_progress, ready_for_payment, completed
  projectNotes    String?   // Notas internas

  // Fechas importantes
  firstPaidAt     DateTime?
  secondPaidAt    DateTime?
  projectStarted  DateTime?
  projectReady    DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  termsAcceptance TermsAcceptance?
  invoices        Invoice[]
  milestones      Milestone[]
  deliverables    Deliverable[]

  clientId  String?
  client    Client? @relation(fields: [clientId], references: [id])

  @@index([email])
  @@index([projectCode])
  @@index([accessToken])
}

model TermsAcceptance {
  id             String        @id @default(cuid())
  userId         String?
  paymentId      String?       @unique // opcional si quieres ligarlo a un pago
  subscriptionId String?       @unique // para suscripciones
  plan           String?
  acceptedAt     DateTime
  ipAddress      String?
  userAgent      String?
  termsVersion   String

  payment        Payment?      @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  subscription   Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
}

model Subscription {
  id                    String    @id @default(uuid())
  stripeSubscriptionId  String    @unique
  stripeCustomerId      String
  email                 String
  name                  String
  planName              String
  amount                Int       // Amount in cents ($200 = 20000)
  currency              String    @default("USD")

  // Status
  status                String    @default("active") // active, cancelled, past_due, unpaid

  // Billing cycle
  currentPeriodStart    DateTime?
  currentPeriodEnd      DateTime?

  // Cancellation
  cancelledAt           DateTime?
  cancelAtPeriodEnd     Boolean   @default(false)

  // Stripe session/checkout info
  stripeSessionId       String?

  // Timestamps
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  termsAcceptance       TermsAcceptance?

  @@index([email])
  @@index([stripeSubscriptionId])
  @@index([stripeCustomerId])
  @@index([status])
}


model SmsLog {
  id          String   @id @default(uuid())
  phoneNumber String
  message     String   @db.Text
  direction   String   // received, sent
  command     String?  // START, STOP, HELP, etc.
  status      String?  // queued, sent, delivered, failed
  twilioSid   String?
  createdAt   DateTime @default(now())

  @@index([phoneNumber])
  @@index([direction])
  @@index([createdAt])
}

model BlogSubscriber {
  id                String    @id @default(uuid())
  email             String    @unique
  preferredLanguage String    @default("en")
  isActive          Boolean   @default(true)
  subscribedAt      DateTime  @default(now())
  unsubscribedAt    DateTime?

  @@index([email])
  @@index([isActive])
  @@index([preferredLanguage])
}

model NotifiedBlogPost {
  id        String   @id @default(uuid())
  slug      String   @unique
  title     String
  notifiedAt DateTime @default(now())

  @@index([slug])
}

// Milestone status enum
enum MilestoneStatus {
  pending
  in_progress
  completed
}

// Project Milestones for tracking detailed progress
model Milestone {
  id          String          @id @default(uuid())
  paymentId   String
  payment     Payment         @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  title       String          // "Design Mockups", "Frontend Development", etc.
  description String?         @db.Text
  order       Int             @default(0) // For sorting milestones
  status      MilestoneStatus @default(pending)
  dueDate     DateTime?
  completedAt DateTime?

  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  notifications MilestoneNotification[]

  @@index([paymentId])
  @@index([status])
  @@index([order])
}

// Notifications for milestone updates (consumed by n8n)
model MilestoneNotification {
  id          String    @id @default(uuid())
  milestoneId String
  milestone   Milestone @relation(fields: [milestoneId], references: [id], onDelete: Cascade)

  type        String    // "completed", "started", "updated"

  // Denormalized data for n8n (avoids extra queries)
  projectCode   String
  clientName    String
  clientEmail   String
  milestoneTitle String
  accessToken   String  // For building the project URL

  sentAt      DateTime? // null = pending, date = sent
  createdAt   DateTime  @default(now())

  @@index([sentAt])
  @@index([createdAt])
}

model Invoice {
  id              String    @id @default(uuid())
  invoiceNumber   String    @unique // "INV-2025-001"
  paymentId       String
  payment         Payment   @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  // Tipo de invoice
  type            String    // "initial", "final", "summary"

  // Datos del cliente (snapshot histórico)
  customerName    String
  customerEmail   String
  projectCode     String    // Denormalizado para fácil búsqueda
  planName        String

  // Detalles financieros (en centavos)
  description     String    @db.Text
  subtotal        Int       // Subtotal en centavos
  taxRate         Float     @default(0) // Porcentaje de impuestos (ej: 8.5 para 8.5%)
  taxAmount       Int       @default(0) // Monto de impuestos en centavos
  total           Int       // Total final en centavos (subtotal + tax)
  currency        String    @default("USD")

  // Almacenamiento del PDF
  pdfUrl          String?   // URL en Vercel Blob
  pdfBlobKey      String?   // Key para eliminar de Vercel Blob si es necesario

  // Metadata de Stripe
  stripeSessionId String?

  // Status y fechas
  status          String    @default("paid") // paid, pending, cancelled
  issueDate       DateTime  @default(now())
  dueDate         DateTime?
  paidDate        DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([paymentId])
  @@index([invoiceNumber])
  @@index([type])
  @@index([customerEmail])
  @@index([projectCode])
  @@index([status])
  @@index([issueDate])
}

model Client {
    id              String    @id @default(uuid())
    email           String    @unique
    password        String?   // Nullable hasta que establezcan contraseña
    name            String
    phone           String?
    emailVerified   DateTime?
    resetToken      String?   // Para reset de contraseña (cuando ya tiene una)
    resetTokenExpiry DateTime?
    setupToken      String?   // Para establecer contraseña inicial (cuando no tiene)
    setupTokenExpiry DateTime? // Expira en 30 días
    createdAt       DateTime  @default(now())
    updatedAt       DateTime  @updatedAt
    lastLogin       DateTime?
    isActive        Boolean   @default(true)

    // Relación con Payment
    payments        Payment[]

    @@index([email])
  }

model Deliverable {
  id          String    @id @default(uuid())
  paymentId   String
  payment     Payment   @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  // Información del archivo
  name        String    // Nombre del archivo/entregable
  description String?   @db.Text // Descripción opcional
  type        String    // "source_code", "documentation", "assets", "credentials", "other"
  fileUrl     String    // URL del archivo en Vercel Blob
  blobKey     String?   // Key para eliminar de Vercel Blob si es necesario
  fileSize    Int?      // Tamaño del archivo en bytes
  mimeType    String?   // Tipo MIME del archivo (application/zip, application/pdf, etc.)

  // Metadata
  uploadedBy  String?   // Email del admin que subió el archivo
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([paymentId])
  @@index([type])
  @@index([createdAt])
}